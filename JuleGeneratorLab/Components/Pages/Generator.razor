@page "/generator"
@using JuleGeneratorLab.Services
@using JuleGeneratorLab.Models
@using System.Text.RegularExpressions // Added this using directive
@inject DatabaseSchemaReader DbSchemaReader
@inject CodeSnippetService SnippetService
@inject CodeGenerationService CodeGenService
@inject IJSRuntime JSRuntime
@inject ProjectService ProjectSvc
@inject DatabaseConnectionService DbConnectionSvc
@inject SnippetSetService SnippetSetSvc

<h3>Code Generator</h3>

<div class="container-fluid">
    <!-- Row 0: Project Selection -->
    <div class="row p-2 my-2 border rounded">
        <div class="col-12">
            <h4>Project Selection</h4>
            @if (availableProjects == null)
            {
                <p><em>Loading projects...</em></p>
            }
            else if (!availableProjects.Any())
            {
                <p>No projects available. Please create a project in the Project Manager.</p>
            }
            else
            {
                <div class="row">
                    <div class="col-md-6">
                        <label for="projectSelector" class="form-label">Select Project:</label>
                        <InputSelect id="projectSelector" class="form-select" @bind-Value="selectedProjectId">
                            <option value="">-- Select a Project --</option>
                            @foreach (var proj in availableProjects)
                            {
                                <option value="@proj.Id" @key="proj.Id">@proj.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-6 align-self-end">
                        <button class="btn btn-info" @onclick="LoadSelectedProject" disabled="@(selectedProjectId == null || selectedProjectId == Guid.Empty)">
                            <i class="bi bi-folder-symlink me-1"></i> Load Project Details
                        </button>
                    </div>
                </div>
            }
            @if (!string.IsNullOrEmpty(projectLoadStatus))
            {
                <div class="mt-2 alert @(currentLoadedProject != null && isProjectLoaded ? "alert-success" : "alert-warning")">
                    @projectLoadStatus
                </div>
            }
        </div>
    </div>

    <!-- Row 1: Database Connection -->
    <div class="row p-2 my-2 border rounded">
        <div class="col-12">
            <h4>@(isProjectLoaded && currentLoadedProject != null ? $"Database Connection (from Project: {currentLoadedProject.Name})" : "Database Connection (Manual)")</h4>
            @if (!isProjectLoaded)
            {
                <div class="mb-3">
                    <label for="serverName" class="form-label">Server Name</label>
                    <input type="text" class="form-control" id="serverName" @bind="connectionDetails.ServerName" />
                </div>
                <div class="mb-3">
                    <label for="databaseName" class="form-label">Database Name</label>
                    <input type="text" class="form-control" id="databaseName" @bind="connectionDetails.DatabaseName" />
                </div>
                <div class="mb-3">
                    <label for="authType" class="form-label">Authentication Type</label>
                    <select class="form-select" id="authType" @bind="connectionDetails.AuthenticationType">
                        <option value="windows">Windows Authentication</option>
                        <option value="sql">SQL Server Authentication</option>
                    </select>
                </div>
                @if (connectionDetails.AuthenticationType == "sql")
                {
                    <div class="mb-3">
                        <label for="userName" class="form-label">User Name</label>
                        <input type="text" class="form-control" id="userName" @bind="connectionDetails.UserName" />
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" @bind="connectionDetails.Password" />
                    </div>
                }
                <button class="btn btn-success" @onclick="() => ConnectToDatabase(null)">Connect (Manual)</button>
            }
            @if (!string.IsNullOrEmpty(connectionStatus))
            {
                <div class="mt-2 alert @(isConnectionSuccess ? "alert-success" : "alert-danger")">
                    @connectionStatus
                </div>
            }
        </div>
    </div>

    <!-- Row 2: Main Area -->
    <div class="row p-2 my-2 border rounded">
        <!-- Column 1: Database Schema Explorer -->
        <div class="col-md-5 border-end">
            <h4>Select Tables (Multiple)</h4>
            @if (tables.Any())
            {
                <div class="list-group" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 4px;">
                    @foreach (var tableNameInList in tables)
                    {
                        <label class="list-group-item" @key="tableNameInList">
                            <input type="checkbox" class="form-check-input me-1"
                                   checked="@(tableSelectionState.ContainsKey(tableNameInList) ? tableSelectionState[tableNameInList] : false)"
                                   @onchange="(ChangeEventArgs e) => ToggleTableSelection(tableNameInList, e.Value)" />
                            @tableNameInList
                        </label>
                    }
                </div>
            }
            else if (isConnectionSuccess)
            {
                <p>No tables found for the current connection.</p>
            }
            else
            {
                <p>Connect to a database to see tables.</p>
            }

            <h4 class="mt-3">Configure Main/Detail Tables:</h4>
            @if (!string.IsNullOrEmpty(columnLoadingError))
            {
                <div class="alert alert-danger">@columnLoadingError</div>
            }
            @if (!selectedRawTableNames.Any())
            {
                <p>No tables selected. Select tables above to configure them.</p>
            }

            @foreach (var tableName in selectedRawTableNames) // Iterate using renamed variable
            {
                <div class="p-3 my-2 border rounded" @key="tableName">
                    <h5>
                        Table: @tableName
                        @if (mainTableName == tableName)
                        {
                            <span class="badge bg-primary ms-1">Main</span>
                        }
                        @if (detailTableName == tableName)
                        {
                            <span class="badge bg-secondary ms-1">Detail</span>
                        }
                    </h5>
                    @if (selectedRawTableNames.Count == 2) {
                        <div class="mb-2">
                            <span class="me-2">Set role:</span>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="@($"role_{SanitizeForHtmlId(tableName)}")" id="@($"role_{SanitizeForHtmlId(tableName)}_Main")" value="Main" checked="@(mainTableName == tableName)" @onchange="() => SetTableRole(tableName, "Main")" />
                                <label class="form-check-label" for="@($"role_{SanitizeForHtmlId(tableName)}_Main")">Main</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="@($"role_{SanitizeForHtmlId(tableName)}")" id="@($"role_{SanitizeForHtmlId(tableName)}_Detail")" value="Detail" checked="@(detailTableName == tableName)" @onchange="() => SetTableRole(tableName, "Detail")" />
                                <label class="form-check-label" for="@($"role_{SanitizeForHtmlId(tableName)}_Detail")">Detail</label>
                            </div>
                        </div>
                    }
                    <div class="mb-3">
                        <label for="@($"alias_{SanitizeForHtmlId(tableName)}")" class="form-label">Alias/ClassName:</label>
                        <input type="text" id="@($"alias_{SanitizeForHtmlId(tableName)}")" class="form-control form-control-sm"
                               @bind="tableAliases[tableName]" @bind:event="oninput" />
                    </div>

                    <h6>Columns for @tableName:</h6>
                    @if (allColumnsForSelectedTables.TryGetValue(tableName, out var columns) && columns.Any())
                    {
                        <div class="list-group mb-2" style="max-height: 250px; overflow-y: auto;">
                            @foreach (var column in columns)
                            {
                                <label class="list-group-item small" @key="column.ColumnName">
                                    <input type="checkbox" class="form-check-input me-1"
                                           checked="@(columnSelectionStates.ContainsKey(tableName) && columnSelectionStates[tableName].ContainsKey(column.ColumnName) ? columnSelectionStates[tableName][column.ColumnName] : false)"
                                           @onchange="(ChangeEventArgs e) => ToggleColumnSelectionForTable(tableName, column.ColumnName, e.Value)" />
                                    @column.ColumnName <small class="text-muted">(@column.DataType @(column.IsPrimaryKey ? "PK" : "") @(column.IsNullable ? "?" : ""))</small>
                                </label>
                            }
                        </div>
                        <button class="btn btn-sm btn-outline-secondary me-1" @onclick="() => SelectAllColumnsForTable(tableName, true)">Select All</button>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => SelectAllColumnsForTable(tableName, false)">Deselect All</button>
                    }
                    else if (allColumnsForSelectedTables.ContainsKey(tableName))
                    {
                        <p>No columns found for this table or still loading.</p>
                    }
                    else
                    {
                         <p>Loading columns for @tableName...</p>
                    }
                </div>
            }
        </div>

        <!-- Column 2: Snippet Selection & Configuration -->
        <div class="col-md-7">
            <h4>Generation Parameters</h4>
            <div class="mb-3">
                <label for="namespaceInput" class="form-label">Namespace:</label>
                <input type="text" class="form-control" id="namespaceInput" @bind="currentNamespace" placeholder="Enter namespace (e.g., MyProject.Models)" />
            </div>
            <div class="mb-3">
                <label for="programNameInput" class="form-label">Program Name:</label>
                <input type="text" class="form-control" id="programNameInput" @bind="currentProgramName" placeholder="Enter program/generator name (e.g., MyAwesomeGenerator)" />
            </div>

            <h4 class="mt-3">Snippet Selection</h4>
            <h5>Snippet Selection Mode:</h5>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="snippetSelectionModeOptions" id="selectIndividualMode" value="individual" @onchange="@(() => HandleSnippetSelectionModeChange("individual"))" checked="@(snippetSelectionMode == "individual")">
                <label class="form-check-label" for="selectIndividualMode">
                    Select Individual Snippets
                </label>
            </div>
            @if (isProjectLoaded && availableSnippetSetsForProject.Any())
            {
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="snippetSelectionModeOptions" id="selectFromSetsMode" value="sets" @onchange="@(() => HandleSnippetSelectionModeChange("sets"))" checked="@(snippetSelectionMode == "sets")">
                    <label class="form-check-label" for="selectFromSetsMode">
                        Select Snippet Set(s) from Project
                    </label>
                </div>
            }

            @if (snippetSelectionMode == "sets" && isProjectLoaded && availableSnippetSetsForProject.Any())
            {
                <h5 class="mt-3">Select Project Snippet Sets:</h5>
                @foreach (var snippetSet in availableSnippetSetsForProject)
                {
                    <div class="form-check" @key="snippetSet.Id">
                        <input class="form-check-input" type="checkbox" id="@($"set_{SanitizeForHtmlId(snippetSet.Id.ToString())}")"
                               checked="@selectedSnippetSetIdsForGeneration.Contains(snippetSet.Id)"
                               @onchange="() => ToggleSnippetSetSelectionForGeneration(snippetSet.Id)">
                        <label class="form-check-label" for="@($"set_{SanitizeForHtmlId(snippetSet.Id.ToString())}")">@snippetSet.Name (@snippetSet.Description)</label>
                    </div>
                }
            }

            @if (snippetSelectionMode == "individual")
            {
                <h5 class="mt-3">Select Individual Snippets:</h5>
                <div class="list-group mt-2" style="max-height: 300px; overflow-y: auto;">
                    @if (FilteredSnippets.Any()) // Use FilteredSnippets
                    {
                        @foreach (var snippet in FilteredSnippets) // Use FilteredSnippets
                        {
                            <label class="list-group-item d-flex justify-content-between align-items-center" @key="snippet.Name">
                                <span>
                                    <input type="checkbox" class="form-check-input me-2"
                                           id="@($"snippet_{SanitizeForHtmlId(snippet.Name)}")"
                                           checked="@(individualSnippetSelectionState.ContainsKey(snippet.Name) ? individualSnippetSelectionState[snippet.Name] : false)"
                                           @onchange="() => ToggleIndividualSnippetSelection(snippet.Name)" />
                                    @snippet.Name
                                </span>
                                <small class="text-muted">@snippet.Description</small>
                            </label>
                        }
                    }
                    else
                    {
                        <p class="list-group-item">No snippets available for selection based on current table/role configuration.</p>
                    }
                </div>
                @if (FilteredSnippets.Any()) // Use FilteredSnippets
                {
                    <button class="btn btn-sm btn-outline-secondary mt-2 me-1" @onclick="() => SelectAllIndividualSnippets(true)">Select All</button>
                    <button class="btn btn-sm btn-outline-secondary mt-2" @onclick="() => SelectAllIndividualSnippets(false)">Deselect All</button>
                }
            }
            <button class="btn btn-primary mt-3" @onclick="HandleGenerateCode">Generate Code</button>
        </div>
    </div>

    <!-- Row 3: Generated Code Output Status -->
    <div class="row p-2 my-2 border rounded">
        <div class="col-12">
            <h4>Generation Status</h4>
            @if (!string.IsNullOrWhiteSpace(generatedCode))
            {
                <div class="alert alert-info">@generatedCode</div>
            }
            else
            {
                 <p><em>Code generation results will appear in a modal.</em></p>
            }
        </div>
    </div>
</div>

<GeneratedCodeModal Results="multipleGeneratedCodeResults"
                  IsVisible="isModalVisible"
                  OnClose="CloseGeneratedCodeModal" />

@code {
    private ConnectionDetails connectionDetails = new ConnectionDetails();
    private string? connectionStatus;
    private bool isConnectionSuccess = false;
    private List<string> tables = new List<string>();

    private List<Project>? availableProjects;
    private Guid? selectedProjectId;
    private Project? currentLoadedProject;
    private string? projectLoadStatus;
    private bool isProjectLoaded = false;

    private List<string> selectedRawTableNames = new List<string>(); // Renamed
    private Dictionary<string, bool> tableSelectionState = new Dictionary<string, bool>();
    private string? mainTableName;
    private string? detailTableName;
    private Dictionary<string, string> tableRoles = new Dictionary<string, string>(); // Key: tableName, Value: "Main" or "Detail"

    private Dictionary<string, string> tableAliases = new Dictionary<string, string>();
    private Dictionary<string, List<ColumnDetail>> allColumnsForSelectedTables = new Dictionary<string, List<ColumnDetail>>();
    private Dictionary<string, Dictionary<string, bool>> columnSelectionStates = new Dictionary<string, Dictionary<string, bool>>();
    private string columnLoadingError = string.Empty;

    private List<CodeSnippet> availableSnippets = new List<CodeSnippet>();
    private string? currentNamespace = "";
    private string? currentProgramName = "";
    private List<SnippetSet> availableSnippetSetsForProject = new List<SnippetSet>();
    private HashSet<Guid> selectedSnippetSetIdsForGeneration = new HashSet<Guid>();
    private Dictionary<string, bool> individualSnippetSelectionState = new Dictionary<string, bool>();
    private string snippetSelectionMode = "individual";

    private List<Models.GeneratedCodeResult> multipleGeneratedCodeResults = new List<Models.GeneratedCodeResult>();
    private bool isModalVisible = false;
    private string generatedCode = "// Select options and click 'Generate Code'.";

    private List<CodeSnippet> FilteredSnippets
    {
        get
        {
            if (!isConnectionSuccess && !isProjectLoaded) // Not connected and no project means no table context
            {
                 // Show only 'Any' applicability snippets if nothing is loaded or connected yet.
                 // Or, if you prefer to show all and let generation fail, return availableSnippets.
                 // For a better UX, filtering by 'Any' makes sense.
                return availableSnippets.Where(s => s.Applicability == SnippetApplicability.Any).ToList();
            }

            if (mainTableName != null && detailTableName != null) // Both Main and Detail selected
            {
                // Show snippets that can handle Main, Detail, or Any.
                // This assumes a snippet marked "Main" could be the primary one for a Main/Detail pair,
                // or a snippet marked "Detail" could be for the detail part.
                // "Any" is versatile.
                // A more complex scenario might involve snippet sets where one snippet is for Main and another for Detail,
                // but individual snippet selection here assumes one snippet handles the chosen context.
                return availableSnippets
                    .Where(s => s.Applicability == SnippetApplicability.Any ||
                                s.Applicability == SnippetApplicability.Main ||
                                s.Applicability == SnippetApplicability.Detail)
                                // This might be too broad. If a snippet is "Main" it might expect only a Main table.
                                // A better approach for Main/Detail might be to only allow "Any" or a specific "MainDetail" type if it existed.
                                // For now, this allows user to pick. Generation logic will use mainTable and detailTable.
                    .ToList();
            }
            else if (mainTableName != null) // Only Main selected
            {
                return availableSnippets
                    .Where(s => s.Applicability == SnippetApplicability.Any || s.Applicability == SnippetApplicability.Main)
                    .ToList();
            }
            // If no tables are selected, or some other undefined state.
            // Show all snippets, or only 'Any'. Let's default to all available if tables aren't specifically configured.
            // However, if isConnectionSuccess or isProjectLoaded is true, but no tables are selected,
            // it might be better to show 'Any' or an empty list.
            // Given the current structure, if mainTableName is null, it implies no specific context.
            return availableSnippets.Where(s => s.Applicability == SnippetApplicability.Any).ToList();
            // Or return availableSnippets; to show all and let user figure out applicability.
            // The above line (Any) is safer to guide the user.
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await SnippetService.EnsureInitializedAsync();
        availableSnippets = SnippetService.Snippets.ToList(); // Load all snippets initially
        individualSnippetSelectionState.Clear();
        // Initialize selection state for ALL snippets, not just filtered ones.
        // The FilteredSnippets list is for display; selection state should be persistent.
        foreach (var snippet in SnippetService.Snippets) // Use SnippetService.Snippets here
        {
            individualSnippetSelectionState[snippet.Name] = false;
        }
        currentNamespace = "";
        currentProgramName = "";
        tableSelectionState = new Dictionary<string, bool>();
        tableAliases = new Dictionary<string, string>();
        allColumnsForSelectedTables = new Dictionary<string, List<ColumnDetail>>();
        columnSelectionStates = new Dictionary<string, Dictionary<string, bool>>();

        try
        {
            availableProjects = await ProjectSvc.GetProjectsAsync();
        }
        catch (Exception ex)
        {
            projectLoadStatus = $"Error loading projects: {ex.Message}";
            availableProjects = new List<Project>();
        }
        await base.OnInitializedAsync();
    }

    private async Task LoadSelectedProject()
    {
        projectLoadStatus = null;
        currentLoadedProject = null;
        isProjectLoaded = false;
        connectionStatus = null;
        tables.Clear();
        selectedRawTableNames.Clear(); // Renamed
        tableSelectionState.Clear();
        mainTableName = null; // Clear new state
        detailTableName = null; // Clear new state
        tableRoles.Clear(); // Clear new state
        availableSnippetSetsForProject.Clear();
        selectedSnippetSetIdsForGeneration.Clear();

        tableAliases.Clear();
        allColumnsForSelectedTables.Clear();
        columnSelectionStates.Clear();
        columnLoadingError = string.Empty;

        if (selectedProjectId == null || selectedProjectId == Guid.Empty)
        {
            projectLoadStatus = "Switched to manual mode. All snippets available.";
            availableSnippets = SnippetService.Snippets.ToList();
        // This loop for individualSnippetSelectionState is already above, ensure it uses the full list.
        // The following was part of the original OnInitializedAsync, ensure it's correct.
        // availableSnippets = SnippetService.Snippets.ToList(); //This is already done above.
        // individualSnippetSelectionState.Clear(); // Already done.
        // foreach (var snippet in availableSnippets) // Already done.
        // {
        //    individualSnippetSelectionState[snippet.Name] = false;
        // }
        snippetSelectionMode = "individual"; // Default mode
            // When project is un-selected (manual mode)
            availableSnippets = SnippetService.Snippets.ToList(); // Reset to all snippets
            individualSnippetSelectionState.Clear();
            foreach (var snippet in availableSnippets) // Reset selection state for all
            {
                individualSnippetSelectionState[snippet.Name] = false;
            }
            snippetSelectionMode = "individual"; // Default to individual
            currentNamespace = "";
            currentProgramName = "";
            connectionStatus = "Manual mode. Please connect to a database.";
            isConnectionSuccess = false;
            await UpdateAndPruneSelectedTableContexts();
        }
        else
        {
            try
            {
                currentLoadedProject = await ProjectSvc.GetProjectByIdAsync(selectedProjectId.Value);
                if (currentLoadedProject == null)
                {
                    projectLoadStatus = "Failed to load selected project details.";
                    currentNamespace = "";
                    currentProgramName = "";
                    snippetSelectionMode = "individual"; // Default
                    availableSnippets = SnippetService.Snippets.ToList(); // Reset to all
                    individualSnippetSelectionState.Clear();
                    foreach (var snippet in availableSnippets) { individualSnippetSelectionState[snippet.Name] = false; } // Reset selection state
                    availableSnippetSetsForProject.Clear();
                    selectedSnippetSetIdsForGeneration.Clear();
                    selectedRawTableNames.Clear(); // Renamed
                    tableSelectionState.Clear();
                    mainTableName = null; // Clear new state
                    detailTableName = null; // Clear new state
                    tableRoles.Clear(); // Clear new state
                    tableAliases.Clear();
                    allColumnsForSelectedTables.Clear();
                    columnSelectionStates.Clear();
                    columnLoadingError = string.Empty;
                    await UpdateAndPruneSelectedTableContexts();
                }
                else
                {
                    isProjectLoaded = true;
                    projectLoadStatus = $"Project '{currentLoadedProject.Name}' loaded.";
                    currentNamespace = currentLoadedProject.Namespace ?? "";
                    currentProgramName = "";

                    if (currentLoadedProject.DatabaseConnectionId.HasValue && currentLoadedProject.DatabaseConnectionId.Value != Guid.Empty)
                    {
                        var dbConn = await DbConnectionSvc.GetConnectionByIdAsync(currentLoadedProject.DatabaseConnectionId.Value);
                        if (dbConn != null)
                        {
                            projectLoadStatus += $" Database connection '{dbConn.Name}' will be used.";
                            await ConnectToDatabase(dbConn.ConnectionString);
                        }
                        else
                        {
                            projectLoadStatus += $" Its associated database connection (ID: {currentLoadedProject.DatabaseConnectionId.Value}) could not be found.";
                            tables.Clear();
                            selectedRawTableNames.Clear(); // Renamed
                            tableSelectionState.Clear();
                            mainTableName = null; // Clear new state
                            detailTableName = null; // Clear new state
                            tableRoles.Clear(); // Clear new state
                            tableAliases.Clear();
                            allColumnsForSelectedTables.Clear();
                            columnSelectionStates.Clear();
                            columnLoadingError = string.Empty;
                            connectionStatus = "Project's DB connection not found.";
                            isConnectionSuccess = false;
                            await UpdateAndPruneSelectedTableContexts();
                        }
                    }
                    else
                    {
                        projectLoadStatus += " It does not have a database connection configured.";
                        tables.Clear();
                        selectedRawTableNames.Clear(); // Renamed
                        tableSelectionState.Clear();
                        mainTableName = null; // Clear new state
                        detailTableName = null; // Clear new state
                        tableRoles.Clear(); // Clear new state
                        tableAliases.Clear();
                        allColumnsForSelectedTables.Clear();
                        columnSelectionStates.Clear();
                        columnLoadingError = string.Empty;
                        connectionStatus = "Project has no DB connection.";
                        isConnectionSuccess = false;
                        await UpdateAndPruneSelectedTableContexts();
                    }

                    var allGlobalSnippets = SnippetService.Snippets.ToList();
                    if (currentLoadedProject.SelectedSnippetSetIds != null && currentLoadedProject.SelectedSnippetSetIds.Any())
                    {
                        List<SnippetSet> setsForProjectUI = new List<SnippetSet>();
                        HashSet<string> snippetNamesFromProjectSets = new HashSet<string>();
                        foreach (var setId in currentLoadedProject.SelectedSnippetSetIds)
                        {
                            var snipSet = await SnippetSetSvc.GetSnippetSetByIdAsync(setId);
                            if (snipSet != null)
                            {
                                setsForProjectUI.Add(snipSet);
                                foreach (var nameInSet in snipSet.SnippetNames) { snippetNamesFromProjectSets.Add(nameInSet); }
                            }
                        }
                        availableSnippetSetsForProject = setsForProjectUI.OrderBy(s => s.Name).ToList();
                        if (availableSnippetSetsForProject.Any())
                        {
                            snippetSelectionMode = "sets";
                            // availableSnippets still holds ALL snippets. FilteredSnippets will use this.
                            // No, for project load, availableSnippets itself should be filtered if sets are defined.
                            availableSnippets = allGlobalSnippets.Where(s => snippetNamesFromProjectSets.Contains(s.Name)).ToList();
                        }
                        else
                        {
                            snippetSelectionMode = "individual";
                            availableSnippets = allGlobalSnippets; // Show all if no sets defined for project
                        }
                    }
                    else
                    {
                        snippetSelectionMode = "individual";
                        availableSnippets = allGlobalSnippets; // Show all if project has no sets
                    }
                    // Reset selection state based on the (potentially) newly filtered availableSnippets
                    individualSnippetSelectionState.Clear();
                    foreach (var snippet in availableSnippets) { individualSnippetSelectionState[snippet.Name] = false; }
                }
            }
            catch (Exception ex)
            {
                projectLoadStatus = $"Error loading project: {ex.Message}";
                isProjectLoaded = false;
                availableSnippets = SnippetService.Snippets.ToList(); // Default to all snippets on error
                currentNamespace = ""; currentProgramName = ""; snippetSelectionMode = "individual";
                selectedRawTableNames.Clear(); tableSelectionState.Clear();
                mainTableName = null; detailTableName = null; tableRoles.Clear();
                tableAliases.Clear(); allColumnsForSelectedTables.Clear(); columnSelectionStates.Clear(); columnLoadingError = string.Empty;
                await UpdateAndPruneSelectedTableContexts();
            }
        }
        StateHasChanged();
    }

    private void SetTableRole(string tableNameToSet, string role)
    {
        if (!selectedRawTableNames.Contains(tableNameToSet) || selectedRawTableNames.Count != 2)
        {
            // Role setting is only applicable when exactly two tables are selected
            // and the table to set is one of them.
            return;
        }

        if (role == "Main")
        {
            if (mainTableName == tableNameToSet) return; // Already main, no change

            mainTableName = tableNameToSet;
            detailTableName = selectedRawTableNames.FirstOrDefault(t => t != mainTableName);
        }
        else if (role == "Detail")
        {
            if (detailTableName == tableNameToSet) return; // Already detail, no change

            detailTableName = tableNameToSet;
            mainTableName = selectedRawTableNames.FirstOrDefault(t => t != detailTableName);
        }

        // Update tableRoles dictionary
        tableRoles.Clear();
        if (mainTableName != null) tableRoles[mainTableName] = "Main";
        if (detailTableName != null) tableRoles[detailTableName] = "Detail";

        StateHasChanged();
    }

    private class ConnectionDetails
    {
        public string ServerName { get; set; } = "localhost";
        public string DatabaseName { get; set; } = "";
        public string AuthenticationType { get; set; } = "windows";
        public string UserName { get; set; } = "";
        public string Password { get; set; } = "";
        public string BuildConnectionString()
        {
            if (AuthenticationType == "windows")
                return $"Server={ServerName};Database={DatabaseName};Trusted_Connection=True;TrustServerCertificate=True;";
            else
                return $"Server={ServerName};Database={DatabaseName};User ID={UserName};Password={Password};TrustServerCertificate=True;";
        }
    }

    private async Task ConnectToDatabase(string? connectionStringFromProject = null)
    {
        connectionStatus = "Connecting...";
        isConnectionSuccess = false;
        tables.Clear();
        selectedRawTableNames.Clear(); // Renamed
        tableSelectionState.Clear();
        mainTableName = null; // Clear new state
        detailTableName = null; // Clear new state
        tableRoles.Clear(); // Clear new state
        tableAliases.Clear();
        allColumnsForSelectedTables.Clear();
        columnSelectionStates.Clear();
        columnLoadingError = string.Empty;
        string connectionString;

        if (isProjectLoaded && !string.IsNullOrEmpty(connectionStringFromProject))
            connectionString = connectionStringFromProject;
        else if (!isProjectLoaded)
            connectionString = connectionDetails.BuildConnectionString();
        else
        {
            connectionStatus = "Project is loaded, but no database connection string was provided.";
            isConnectionSuccess = false;
            await UpdateAndPruneSelectedTableContexts();
            StateHasChanged();
            return;
        }

        try
        {
            var fetchedTables = DbSchemaReader.GetTables(connectionString);
            if (fetchedTables != null && fetchedTables.Any())
            {
                tables = fetchedTables.OrderBy(t => t).ToList();
                connectionStatus = $"Successfully connected and retrieved {tables.Count} table(s).";
                isConnectionSuccess = true;
                tableSelectionState.Clear();
                foreach (var tableNameInListLoop in tables)
                {
                    tableSelectionState[tableNameInListLoop] = false;
                }
                selectedRawTableNames.Clear(); // Renamed
            }
            else
            {
                connectionStatus = "Connected, but no user tables were found.";
                isConnectionSuccess = true;
                tableSelectionState.Clear();
                selectedRawTableNames.Clear(); // Renamed
            }
        }
        catch (Exception ex)
        {
            connectionStatus = $"Error connecting: {ex.Message}";
            isConnectionSuccess = false;
        }
        await UpdateAndPruneSelectedTableContexts();
        StateHasChanged();
    }

    private async Task UpdateAndPruneSelectedTableContexts()
    {
        columnLoadingError = string.Empty;
        // Use selectedRawTableNames for pruning and loading logic
        var currentRawSelection = selectedRawTableNames.ToHashSet();

        var tablesToRemove = allColumnsForSelectedTables.Keys.Where(t => !currentRawSelection.Contains(t)).ToList();
        foreach (var tableName in tablesToRemove)
        {
            allColumnsForSelectedTables.Remove(tableName);
            tableAliases.Remove(tableName);
            columnSelectionStates.Remove(tableName);
            // Also remove from tableRoles if present
            if (tableRoles.ContainsKey(tableName)) tableRoles.Remove(tableName);
        }

        // If a table that was main or detail is no longer selected, nullify mainTableName/detailTableName
        if (mainTableName != null && !currentRawSelection.Contains(mainTableName)) mainTableName = null;
        if (detailTableName != null && !currentRawSelection.Contains(detailTableName)) detailTableName = null;


        foreach (var tableName in selectedRawTableNames) // Iterate using renamed variable
        {
            if (!allColumnsForSelectedTables.ContainsKey(tableName))
            {
                tableAliases[tableName] = CodeGenService.NormalizeClassName(tableName);

                string connectionStringForColumns;
                if (isProjectLoaded && currentLoadedProject?.DatabaseConnectionId != null)
                {
                    var dbConn = await DbConnectionSvc.GetConnectionByIdAsync(currentLoadedProject.DatabaseConnectionId.Value);
                    if (dbConn == null) {
                        columnLoadingError += $"Project's DB connection not found for loading columns for {tableName}. ";
                        allColumnsForSelectedTables[tableName] = new List<ColumnDetail>();
                        columnSelectionStates[tableName] = new Dictionary<string, bool>();
                        continue;
                    }
                    connectionStringForColumns = dbConn.ConnectionString;
                }
                else if (!isProjectLoaded && isConnectionSuccess)
                {
                    connectionStringForColumns = connectionDetails.BuildConnectionString();
                }
                else
                {
                    columnLoadingError += $"Cannot load columns for {tableName}: No valid DB connection. ";
                    allColumnsForSelectedTables[tableName] = new List<ColumnDetail>();
                    columnSelectionStates[tableName] = new Dictionary<string, bool>();
                    continue;
                }

                try
                {
                    var columns = DbSchemaReader.GetColumns(connectionStringForColumns, tableName);
                    allColumnsForSelectedTables[tableName] = columns ?? new List<ColumnDetail>();

                    var selections = new Dictionary<string, bool>();
                    foreach (var col in allColumnsForSelectedTables[tableName])
                    {
                        selections[col.ColumnName] = true;
                    }
                    columnSelectionStates[tableName] = selections;
                }
                catch (Exception ex)
                {
                    columnLoadingError += $"Error loading columns for {tableName}: {ex.Message}. ";
                    allColumnsForSelectedTables[tableName] = new List<ColumnDetail>();
                    columnSelectionStates[tableName] = new Dictionary<string, bool>();
                }
            }
        }
        StateHasChanged();
    }

    private async Task ToggleTableSelection(string tableName, object? checkedValue)
    {
        bool isSelected = (bool)(checkedValue ?? false);
        if (tableSelectionState.ContainsKey(tableName))
        {
            tableSelectionState[tableName] = isSelected;
        }

        selectedRawTableNames = tableSelectionState // Update renamed variable
                                .Where(kvp => kvp.Value)
                                .Select(kvp => kvp.Key)
                                .OrderBy(name => name)
                                .ToList();

        if (selectedRawTableNames.Count > 2)
        {
            // Max 2 tables allowed. Revert the last selection and show an error.
            tableSelectionState[tableName] = !isSelected; // Revert
            selectedRawTableNames = tableSelectionState // Recalculate
                                    .Where(kvp => kvp.Value)
                                    .Select(kvp => kvp.Key)
                                    .OrderBy(name => name)
                                    .ToList();
            // TODO: Show a user-friendly error message via a new feedback variable
            await JSRuntime.InvokeVoidAsync("alert", "You can select a maximum of two tables.");
            StateHasChanged(); // Update UI if needed for the reverted checkbox
            return;
        }

        tableRoles.Clear(); // Clear existing roles before re-assigning

        if (selectedRawTableNames.Count == 1)
        {
            mainTableName = selectedRawTableNames.First();
            detailTableName = null;
            if (mainTableName != null) tableRoles[mainTableName] = "Main";
        }
        else if (selectedRawTableNames.Count == 2)
        {
            // If mainTableName is not among the selected, or was null, assign the first one as Main.
            if (mainTableName == null || !selectedRawTableNames.Contains(mainTableName))
            {
                 mainTableName = selectedRawTableNames.First();
            }
            detailTableName = selectedRawTableNames.FirstOrDefault(t => t != mainTableName);

            if (mainTableName != null) tableRoles[mainTableName] = "Main";
            if (detailTableName != null) tableRoles[detailTableName] = "Detail";

            // Ensure main and detail are not the same if something went wrong
            if (mainTableName == detailTableName && mainTableName != null) {
                // This case should ideally not be reached if selection logic is correct.
                mainTableName = selectedRawTableNames[0];
                detailTableName = selectedRawTableNames[1];
                tableRoles.Clear();
                tableRoles[mainTableName] = "Main";
                tableRoles[detailTableName] = "Detail";
            }
        }
        else // 0 selected
        {
            mainTableName = null;
            detailTableName = null;
        }

        await UpdateAndPruneSelectedTableContexts();
    }

    private void ToggleColumnSelectionForTable(string tableName, string columnName, object? checkedValue)
    {
        bool isSelected = (bool)(checkedValue ?? false);
        if (columnSelectionStates.TryGetValue(tableName, out var selections))
        {
            selections[columnName] = isSelected;
            StateHasChanged();
        }
    }

    private void SelectAllColumnsForTable(string tableName, bool select)
    {
        if (columnSelectionStates.TryGetValue(tableName, out var selections) &&
            allColumnsForSelectedTables.TryGetValue(tableName, out var columns))
        {
            foreach (var col in columns)
            {
                selections[col.ColumnName] = select;
            }
            StateHasChanged();
        }
    }

    private void HandleSnippetSelectionModeChange(string mode)
    {
        snippetSelectionMode = mode;
        if (mode == "individual") selectedSnippetSetIdsForGeneration.Clear();
        StateHasChanged();
    }

    private void ToggleSnippetSetSelectionForGeneration(Guid setId)
    {
        if (selectedSnippetSetIdsForGeneration.Contains(setId))
            selectedSnippetSetIdsForGeneration.Remove(setId);
        else
            selectedSnippetSetIdsForGeneration.Add(setId);
        StateHasChanged();
    }

    private void ToggleIndividualSnippetSelection(string snippetName)
    {
        if (individualSnippetSelectionState.ContainsKey(snippetName))
            individualSnippetSelectionState[snippetName] = !individualSnippetSelectionState[snippetName];
        else
            individualSnippetSelectionState[snippetName] = true;
        StateHasChanged();
    }

    private void SelectAllIndividualSnippets(bool select)
    {
        // This should select/deselect based on FilteredSnippets, as those are the ones visible to the user.
        var snippetNames = FilteredSnippets.Select(s => s.Name).ToList();
        foreach (var name in snippetNames)
        {
            if (individualSnippetSelectionState.ContainsKey(name))
            {
                individualSnippetSelectionState[name] = select;
            }
        }
        StateHasChanged();
    }

    private async Task HandleGenerateCode()
    {
        multipleGeneratedCodeResults.Clear();
        isModalVisible = false;
        generatedCode = ""; // Clear previous status messages

        if (string.IsNullOrEmpty(mainTableName)) // Check mainTableName
        {
            generatedCode = "Please select a main table.";
            StateHasChanged();
            return;
        }

        List<CodeSnippet> snippetsToGenerate = new List<CodeSnippet>();
        if (snippetSelectionMode == "individual")
        {
            var selectedNames = individualSnippetSelectionState.Where(kv => kv.Value).Select(kv => kv.Key).ToHashSet();
            if (selectedNames.Any())
            {
                snippetsToGenerate = availableSnippets.Where(s => selectedNames.Contains(s.Name)).ToList();
            }
        }
        else if (snippetSelectionMode == "sets")
        {
            if (selectedSnippetSetIdsForGeneration.Any() && availableSnippetSetsForProject.Any())
            {
                var snippetNamesFromSelectedSets = new HashSet<string>();
                foreach (var setId in selectedSnippetSetIdsForGeneration)
                {
                    var snippetSet = availableSnippetSetsForProject.FirstOrDefault(s => s.Id == setId);
                    if (snippetSet != null)
                    {
                        foreach (var name in snippetSet.SnippetNames)
                        {
                            snippetNamesFromSelectedSets.Add(name);
                        }
                    }
                }
                await SnippetService.EnsureInitializedAsync();
                snippetsToGenerate = SnippetService.Snippets.Where(s => snippetNamesFromSelectedSets.Contains(s.Name)).ToList();
            }
        }

        if (!snippetsToGenerate.Any())
        {
            generatedCode = "Please select at least one code snippet or a snippet set.";
            StateHasChanged();
            return;
        }

        // Prepare mainTableContext
        if (mainTableName == null) { // This check is a bit redundant due to the one above, but good for safety
            generatedCode = "Error: Main table is not set.";
            StateHasChanged(); return;
        }

        string mainUserAlias = tableAliases.TryGetValue(mainTableName, out var mainAlias) && !string.IsNullOrWhiteSpace(mainAlias)
                                ? mainAlias : CodeGenService.NormalizeClassName(mainTableName);
        List<ColumnDetail> mainAllCols = allColumnsForSelectedTables.TryGetValue(mainTableName, out var mCols) ? mCols : new List<ColumnDetail>();
        List<ColumnDetail> mainSelectedCols = new List<ColumnDetail>();
        if (columnSelectionStates.TryGetValue(mainTableName, out var mainSelections))
        {
            foreach (var colDetail in mainAllCols)
            {
                if (mainSelections.TryGetValue(colDetail.ColumnName, out var isSelected) && isSelected)
                {
                    mainSelectedCols.Add(colDetail);
                }
            }
        }
        if (!mainSelectedCols.Any())
        {
            generatedCode = $"Error: Main table '{mainTableName}' ({mainUserAlias}) has no columns selected.";
            StateHasChanged(); return;
        }
        var mainTableContext = new TableGenerationContext
        {
            TableName = mainTableName,
            UserAlias = mainUserAlias,
            ClassName = CodeGenService.NormalizeClassName(mainUserAlias),
            SelectedColumns = mainSelectedCols
        };

        TableGenerationContext? detailTableContext = null;
        if (!string.IsNullOrEmpty(detailTableName))
        {
            string detailUserAlias = tableAliases.TryGetValue(detailTableName, out var detAlias) && !string.IsNullOrWhiteSpace(detAlias)
                                     ? detAlias : CodeGenService.NormalizeClassName(detailTableName);
            List<ColumnDetail> detailAllCols = allColumnsForSelectedTables.TryGetValue(detailTableName, out var dCols) ? dCols : new List<ColumnDetail>();
            List<ColumnDetail> detailSelectedCols = new List<ColumnDetail>();
            if (columnSelectionStates.TryGetValue(detailTableName, out var detailSelections))
            {
                foreach (var colDetail in detailAllCols)
                {
                    if (detailSelections.TryGetValue(colDetail.ColumnName, out var isSelected) && isSelected)
                    {
                        detailSelectedCols.Add(colDetail);
                    }
                }
            }
            if (!detailSelectedCols.Any())
            {
                generatedCode = $"Error: Detail table '{detailTableName}' ({detailUserAlias}) is selected but has no columns selected.";
                StateHasChanged(); return;
            }
            detailTableContext = new TableGenerationContext
            {
                TableName = detailTableName,
                UserAlias = detailUserAlias,
                ClassName = CodeGenService.NormalizeClassName(detailUserAlias),
            SelectedColumns = detailSelectedCols
            };
        }

        foreach (var snippet in snippetsToGenerate)
        {
            string baseNameForFile = mainTableContext.UserAlias;

            string generatedOutput = CodeGenService.GenerateCode(
                mainTableContext,
                snippet,
                currentNamespace ?? "",
                currentProgramName ?? "",
                detailTableContext
            );

            multipleGeneratedCodeResults.Add(new Models.GeneratedCodeResult
            {
                SnippetName = snippet.Name,
                GeneratedContent = generatedOutput,
                SuggestedFileName = GenerateFileName(snippet, baseNameForFile, currentProgramName, currentNamespace)
            });
        }

        // The remnant code block identified in the review has been removed.
        // The logic now correctly concludes after populating multipleGeneratedCodeResults
        // and then proceeds to the final status update.

        if (multipleGeneratedCodeResults.Any())
        {
            generatedCode = $"// {multipleGeneratedCodeResults.Count} snippet(s) generated. Displaying in modal.";
            isModalVisible = true;
        }
        else
        {
           generatedCode = "// No code was generated. Check selections.";
        }
        StateHasChanged();
    }

    private string GenerateFileName(CodeSnippet snippet, string? baseNameFromTable, string? programName, string? namespaceVal)
    {
        string baseName = string.IsNullOrWhiteSpace(baseNameFromTable) ? "Output" : baseNameFromTable;
        string snippetNamePart = snippet.Name.Replace(" ", "").Replace("(", "").Replace(")", "").Replace("/", "-");
        // Use OutputFileExtension from snippet model
        string extension = snippet.OutputFileExtension;
        // Ensure extension includes a dot, add if missing (though model should handle this)
        if (!string.IsNullOrWhiteSpace(extension) && !extension.StartsWith("."))
        {
            extension = "." + extension;
        }
        else if (string.IsNullOrWhiteSpace(extension))
        {
            extension = ".txt"; // Fallback if not set
        }
        return $"{baseName}_{snippetNamePart}{extension}";
    }

    private void CloseGeneratedCodeModal()
    {
        isModalVisible = false;
        StateHasChanged();
    }

    private string SanitizeForHtmlId(string input)
    {
        if (string.IsNullOrEmpty(input))
        {
            return string.Empty;
        }
        // Replace common problematic characters with underscore, ensure it starts with a letter or underscore.
        var sanitized = System.Text.RegularExpressions.Regex.Replace(input, @"[^a-zA-Z0-9_.-]", "_");
        if (sanitized.Length > 0 && !char.IsLetter(sanitized[0]) && sanitized[0] != '_')
        {
            sanitized = "_" + sanitized;
        }
        else if (sanitized.Length == 0)
        {
            return "_empty_"; // Or some other default for entirely invalid input
        }
        return sanitized;
    }
}
